# Система клоакинга для iOS приложения

## Описание

Система клоакинга добавлена к существующему приложению Vavada GPM для определения, показывать ли пользователю WebView с казино или оставить на белой заглушке.

## ⚠️ Критические исправления

### Исправление сохранения сессии (куки)
**Проблема:** Пользователи терялись сессия и приходилось заново авторизоваться при каждом запуске приложения.

**Решение:** 
- Создан кастомный `WKWebsiteDataStore` с постоянной директорией `Documents/WebViewData`
- Убраны методы "принудительного" сохранения куки
- Куки теперь автоматически сохраняются между перезапусками

### Исправление альбомной ориентации
**Проблема:** WebView поддерживал только портретную ориентацию.

**Решение:**
- Добавлены принудительные методы смены ориентации в `OrientationManager`
- Используется `windowScene.requestGeometryUpdate()` для iOS 16+
- Совместимость с iOS 15 через старые API методы
- Автоматическое переключение ориентаций при входе/выходе из WebView

## Основные компоненты

### 1. StorageManager
- Управляет локальным хранилищем через UserDefaults
- Сохраняет дату первого запуска
- Хранит результат клоакинга
- Отслеживает network errors

### 2. CloakingService
- Делает запросы к кейтаро трекеру
- URL трекера: `https://zhenazanag.pro/7L7RRMSF`
- Настраиваемый период ожидания (по умолчанию 3 дня)
- Обрабатывает HTTP статусы согласно логике

### 3. AppStateManager
- Управляет состоянием приложения
- Определяет что показывать (WebView или белую часть)
- Предоставляет методы для тестирования

### 4. CasinoWebView
- WebView контейнер с тулбаром
- Настройки оптимизированы для казино
- **Надежное сохранение куки между сессиями**
- Поддержка JavaScript
- **Поддержка всех ориентаций (портретная + альбомная)**
- Кнопка "Назад" в тулбаре

### 5. OrientationManager
- Управляет ориентацией экрана
- **Принудительное переключение ориентаций через iOS API**
- WebView поддерживает все ориентации
- Остальные экраны только портретная

## Логика работы

1. **При запуске приложения:**
   - Проверяется, прошло ли 3 дня с первого запуска
   - Если НЕТ → показывается белая часть
   - Если ДА → проверяется сохраненный результат или делается запрос

2. **Обработка ответа кейтаро:**
   - HTTP 200 → показать WebView с полученной ссылкой
   - HTTP 404 → показать белую часть
   - Ошибка сети → показать белую часть, НЕ сохранять результат

3. **Сохранение результата:**
   - При успешном ответе результат сохраняется навсегда
   - При network error результат НЕ сохраняется

## Тестирование

### Debug панель

В Debug режиме доступна панель тестирования:
1. На главном экране появляется кнопка "TESTING PANEL"
2. Панель показывает текущее состояние
3. Доступны кнопки для управления:
   - Force Show WebView
   - Force Show White Part
   - Clear All Data & Restart
   - Simulate 3 Days Passed

### Изменение параметров

1. **URL трекера:**
   ```swift
   CloakingService.shared.setTrackerURL("новый_url")
   ```

2. **Количество дней ожидания:**
   Измените константу в `CloakingService`:
   ```swift
   static let daysBeforeActivation = 3
   ```

### Тестовые сценарии

1. **Первый запуск:**
   - Очистите данные через Testing Panel
   - Приложение должно показать белую часть

2. **После 3 дней:**
   - Используйте "Simulate 3 Days Passed"
   - Должен выполниться запрос к трекеру

3. **Успешный клоакинг:**
   - Force Show WebView
   - WebView должен открыться с тулбаром

4. **Network error:**
   - Отключите интернет
   - Симулируйте 3 дня
   - Должна показаться белая часть

5. **Тестирование сохранения сессии:**
   - Авторизуйтесь в казино через WebView
   - Закройте приложение полностью
   - Откройте снова - должна сохраниться авторизация

6. **Тестирование ориентации:**
   - Откройте WebView
   - Поверните устройство в альбомную ориентацию
   - WebView должен повернуться
   - Закройте WebView - приложение вернется в портретную

## WebView особенности

### Настройки для казино:
- **Кастомный dataStore с постоянным хранилищем куки**
- JavaScript включен
- Поддержка полноэкранного режима
- Автовоспроизведение медиа
- User Agent для мобильных устройств

### Тулбар:
- Кнопка "Назад" (активна только когда можно вернуться)
- Кнопка "Вперед" 
- В Debug режиме есть кнопка закрытия

### Ориентация:
- **Все ориентации поддерживаются в WebView**
- Автоматическое переключение при входе/выходе
- Принудительное обновление через iOS API

## Важные моменты

1. **Безопасность:**
   - Результат клоакинга сохраняется в UserDefaults
   - WebView использует кастомный dataStore в Documents директории

2. **Производительность:**
   - WebView создается только при необходимости
   - **Куки сохраняются автоматически и надежно**

3. **UX:**
   - Индикатор загрузки при открытии WebView
   - Плавные переходы между состояниями
   - Поддержка жестов навигации
   - **Поддержка альбомной ориентации для игр**

## Интеграция

Система полностью интегрирована в существующее приложение:
- `Vavada_GPMApp.swift` управляет показом WebView или ContentView
- AppDelegate добавлен для управления ориентацией
- Белая часть приложения не изменена 

## Техническая архитектура файлов

### WebView компоненты:
- `CasinoWebView.swift` - SwiftUI обертка с тулбаром
- `CasinoWebViewRepresentable.swift` - UIViewRepresentable с кастомным dataStore
- `WebViewStore.swift` - менеджер состояния WebView

### Утилиты:
- `OrientationManager.swift` - управление ориентацией с принудительными методами
- `StorageManager.swift` - локальное хранилище данных клоакинга

### Сервисы:
- `CloakingService.swift` - логика клоакинга и запросы к трекеру
- `AppStateManager.swift` - управление состоянием приложения 