# Система клоакинга для iOS приложения

## Описание

Система клоакинга добавлена к существующему приложению Vavada GPM для определения, показывать ли пользователю WebView с казино или оставить на белой заглушке.

## ✅ Полностью рабочая система

### Исправление сохранения сессии (куки)
**Решение:** 
- Создан глобальный `GlobalWebViewManager` - синглтон который сохраняет ОДИН WebView на всё время работы приложения
- Принудительное сохранение куки в `HTTPCookieStorage.shared` после каждой загрузки
- Куки сохраняются при закрытии WebView и сворачивании приложения
- Один `processPool` и `dataStore` на всё приложение

### Исправление альбомной ориентации
**Решение:**
- Полностью переписан `OrientationManager` для iOS 16.6+
- Использует `windowScene.requestGeometryUpdate()` - современный API iOS 16+
- Принудительное обновление поддерживаемых ориентаций через активную `windowScene`
- Автоматическое переключение ориентаций при входе/выходе из WebView

## Основные компоненты

### 1. StorageManager
- Управляет локальным хранилищем через UserDefaults
- Сохраняет дату первого запуска
- Хранит результат клоакинга
- Отслеживает network errors

### 2. CloakingService
- Делает запросы к кейтаро трекеру
- URL трекера: `https://zhenazanag.pro/7L7RRMSF`
- Настраиваемый период ожидания (по умолчанию 3 дня)
- Обрабатывает HTTP статусы согласно логике

### 3. AppStateManager
- Управляет состоянием приложения
- Определяет что показывать (WebView или белую часть)
- Предоставляет методы для тестирования

### 4. CasinoWebView
- WebView контейнер с тулбаром
- Настройки оптимизированы для казино
- Надежное сохранение куки между сессиями
- Поддержка JavaScript
- Поддержка всех ориентаций (портретная + альбомная)
- Навигационные кнопки в тулбаре

### 5. GlobalWebViewManager
- Синглтон для управления единственным экземпляром WebView
- Автоматическое сохранение куки
- Оптимизированная конфигурация для казино

### 6. OrientationManager
- Управляет ориентацией экрана
- Принудительное переключение ориентаций через iOS API
- WebView поддерживает все ориентации
- Остальные экраны только портретная

## Логика работы

1. **При запуске приложения:**
   - Проверяется, прошло ли 3 дня с первого запуска
   - Если НЕТ → показывается белая часть
   - Если ДА → проверяется сохраненный результат или делается запрос

2. **Обработка ответа кейтаро:**
   - HTTP 200 → показать WebView с полученной ссылкой
   - HTTP 404 → показать белую часть
   - Ошибка сети → показать белую часть, НЕ сохранять результат

3. **Сохранение результата:**
   - При успешном ответе результат сохраняется навсегда
   - При network error результат НЕ сохраняется

## WebView особенности

### Настройки для казино:
- Глобальный WebView с постоянным хранилищем куки
- JavaScript включен
- Поддержка полноэкранного режима
- Автовоспроизведение медиа
- User Agent для мобильных устройств

### Тулбар:
- Кнопка "Назад" (активна только когда можно вернуться)
- Кнопка "Вперёд"

### Ориентация:
- Все ориентации поддерживаются в WebView
- Автоматическое переключение при входе/выходе 
- Принудительное обновление через iOS API

## Важные моменты

1. **Безопасность:**
   - Результат клоакинга сохраняется в UserDefaults
   - WebView использует глобальный dataStore

2. **Производительность:**
   - WebView создается один раз и переиспользуется
   - Куки сохраняются автоматически и надежно

3. **UX:**
   - Плавные переходы между состояниями
   - Поддержка жестов навигации
   - Поддержка альбомной ориентации для игр

## Интеграция

Система полностью интегрирована в существующее приложение:
- `Vavada_GPMApp.swift` управляет показом WebView или ContentView
- AppDelegate добавлен для управления ориентацией
- Белая часть приложения не изменена 

## Техническая архитектура файлов

### WebView компоненты:
- `CasinoWebView.swift` - SwiftUI обертка с тулбаром
- `CasinoWebViewRepresentable.swift` - UIViewRepresentable с глобальным WebView
- `WebViewStore.swift` - менеджер состояния WebView
- `GlobalWebViewManager.swift` - синглтон для управления WebView

### Утилиты:
- `OrientationManager.swift` - управление ориентацией с принудительными методами
- `StorageManager.swift` - локальное хранилище данных клоакинга

### Сервисы:
- `CloakingService.swift` - логика клоакинга и запросы к трекеру
- `AppStateManager.swift` - управление состоянием приложения 